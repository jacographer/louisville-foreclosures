<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Louisville Foreclosures</title>
	<!-- Add icon library -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
		integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<!-- Leaflet CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
		integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14=" crossorigin="" />
	<!-- Fonts -->
	<link
		href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Nunito:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;0,1000;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900;1,1000&display=swap"
		rel="stylesheet">
	<style>
		body {
			background: #20282e;
			font-family: 'Nunito', sans-serif;
			font-weight: 400;
		}

		h1 {
			font-family: 'Bitter', serif;
			font-weight: 600;
		}

		h3 {
			font-weight: 200;
			font-size: 1.1rem;
		}

		h4 {
			font-family: 'Nunito', sans-serif;
			font-weight: 200;
			font-size: 0.9rem;
			text-align: center;
			font-style: italic;
			color: lightgray;
		}

		p {
			line-height: 1rem;
		}

		a {
			color: lightgray;
		}

		ul li {
			padding-left: 0.5rem
		}

		a:hover {
			color: gold
		}

		#map {
			height: 60vh;
			background: #262626;
		}

		#search-bar {
			font-family: 'Nunito', sans-serif;
			background-color: white;
			font-style: italic;
			color: black;
			font-size: 0.9rem;
			text-align: center;
			margin: auto;
			height: 2.5rem;
			width: 95%;
			border-radius: 7.5px;
			border: none
		}

		#search-bar:hover {
			border: 1.5px solid gold;
		}

		#search-candidate {
			font-family: 'Nunito', sans-serif;
			background-color: black;
			color: gold;
			font-size: 0.9rem;
			height: 2.5rem;
			width: 95%;
			border: 1.5px solid gold;
			border-radius: 7.5px
		}

		.modal-content {
			font-size: 0.9rem;
			width: 100%;
			background-color: black;
			border: 1.5px solid gold;
			color: lightgray;
			padding: 0.5rem;
		}

		#top-purchasers-table {
			font-size: 0.9rem;
			border: 1px solid black;
			border-collapse: collapse;
			width: 95%;
		}

		#top-purchasers-table th {
			color: gold;
			text-align: center;
			font-size: 0.9rem;
			border: 0.5px solid lightgray;
			padding: 8px;
			width: 75%;
		}

		#top-purchasers-table td {
			font-size: 0.9rem;
			border: 0.5px solid lightgray;
			padding: 8px;
			width: 75%;
		}

		#ui-toggle {
			background-color: #fb9a99;
			color: black;
			font-size: 0.9rem;
			border-radius: 7.5px;
			text-align: center;
			height: 2.5rem;
			width: 75%;
			border: none
		}

		#ui-toggle:hover {
			border: 1.5px solid gold;
		}

		#dropdown-ui {
			width: 100%;
		}

		#modalButton {
			font-size: 0.9rem;
			background-color: lightgray;
			color: black;
			height: 2.5rem;
			width: 95%;
			border: none;
			border-radius: 7.5px
		}

		#modalButton:hover {
			background-color: darkgray;
			border: 1.5px solid gold;
		}

		.leaflet-popup {
			font-family: 'Bitter', serif;
		}

		/* 480px and up */
		@media (min-width: 480px) {
			aside {
				height: 80vh;
			}

			#map {
				height: 80vh;
			}
		}

		.hide {
			display: none;
		}

		.show {
			display: block;
		}
	</style>

</head>

<body>
	<div class="container-fluid">
		<header class="row bg-black text-white py-3">
			<div class="col">
				<h1>Foreclosures in Louisville KY, 2016-2020</h1>
			</div>
		</header>

		<section class="row">
			<div class="col-md-8 col-lg-9 col-xl-8 order-md-1 px-0">
				<div id="map"></div>
			</div>
			<aside id="about"
				class="col-md-4 col-lg-3 col-xl-4 order-md-2 text-white py-2 pl-3 bg-black overflow-auto align-right">
				<section>

					<h3 class="py-2">
						<b>&#x2630 Select</b><i> the year to highlight:</i><br><br>
						<!-- ui-controls -->
						<div class="btn " id="dropdown-ui">
							<select id="ui-toggle" class="dropdown-toggle">
								<option value="2020" selected>2020</option>
								<option value="2019">2019</option>
								<option value="2018">2018</option>
								<option value="2017">2017</option>
								<option value="2016">2016</option>
							</select>
						</div>
						<!-- end ui-controls -->

						<br><br><b>&#x25C9 Click</b><i> on points for foreclosure sale details.</i><br><br>
						<!-- Button trigger modal -->
						<button id="modalButton" type="button" class="btn">
							More about foreclosure sales
						</button>

						<!-- Modal -->
						<div class="modal fade" id="infoModal" tabindex="-1" role="dialog">
							<div class="modal-dialog" role="document">
								<div class="modal-content">
									Foreclosure sales happen when banks foreclose on properties. The properties are auctioned off through
									the Circuit Court, from whose annual documentation these property's addressed were mapped.<br><br>Not
									all foreclosed properties are sold. Many on this map were 'Withdrawn,' meaning that foreclosure
									proceedings began but no sale occured. Commonly, this means that the property
									owners...etc.<br><br>Find the source data at the <a href="https://www.jeffcomm.org/past-results.html"
										target="_blank">Jefferson County Circuit
										Court Commissioner's Office</a>
								</div>
							</div>
						</div>

						<br><br><b>&#128270
							Search</b><i> foreclosure sales by address:</i><br><br>

						<input type="text" id="search-bar" placeholder="Begin typing address..."></input>
						<div id='search-results'>
							<select id="search-candidate" name="search-output" class="hide">
							</select>
						</div>
						<br>
						<b>&#8862 View</b><i> top purchasers for the selected year*:</i>
						<br>
					</h3>
					<table id="top-purchasers-table">
						<thead>
							<tr>
								<!-- <th>Rank</th> -->
								<th>Name</th>
								<th>Properties</th>
							</tr>
						</thead>
						<tbody>
							<!-- Table rows will be added here by the updateTable function -->
						</tbody>
					</table>
					<br>
					<h4><i>*Excluding withdrawn foreclosure sales and properties purchased by Jefferson County</i></h4>
				</section>
			</aside>
		</section>
		<footer class="row bg-black text-white py-3">
			<div class="col">
				<h4>
					Map created by <a href="https://jacographer.com" target="_blank">Jacob Saindon</a> &
					<a href="https://mmccanless.github.io" target="_blank">Michael McCanless</a> | Nov. 2022 | <a
						href="https://github.com/jacographer/louisville-foreclosures/blob/main/readme.md"
						target="_blank">Metadata</a><br>
					Many thanks to <a href="https://boydx.github.io" target="_blank">Boyd Shearer</a> for his instruction and
					assistance.
				</h4>
		</footer>
	</div>

	<!-- Add Bootstrap -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
		integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous">
		</script>
	<!-- then Leaflet JS -->
	<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
		integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>
	<!-- Leaflet Search JS -->
	<script src="https://opengeo.tech/maps/leaflet-search/dist/leaflet-search.min.js"></script>
	<!-- then Simple Statistics -->
	<script src='https://unpkg.com/simple-statistics@7.7.0/dist/simple-statistics.min.js'></script>

	<script>
		// initial Leaflet map options
		const options = {
			zoomSnap: 1,
			center: [38.22, -85.775],
			zoom: 11.5,
			minZoom: 10,
			maxZoom: 17,
			zoomControl: false,
		};
		// create Leaflet map and apply options
		const map = L.map("map", options)
		new L.control.zoom({
			position: "bottomright"
		}).addTo(map);

		// request a basemap tile layer and add to the map
		L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		// fetch data from a remote source
		fetch("data/point-foreclosures-all.geojson")
			.then(function (response) {
				if (response.ok) {
					return response.json();
				} else {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
			})
			.then(function (data) {
				console.log(data);
				// call draw map and send data as parameter
				drawMap(data);
			});

		let attributeValue = "2020"; // Employed

		function drawMap(data) {
			// create Leaflet data layer and add to map
			var pointStyles = {
				radius: 5,
				fillColor: "#ff7800",
				color: "rgba (0,0,0,0)",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.9
			}
			const addresses = L.geoJson(data, {
				// style counties with initial default path options
				pointToLayer: function (feature, latlng) {
					latlng = [makeRandom(latlng.lat), makeRandom(latlng.lng)]
					return L.circleMarker(latlng, pointStyles)
				},

				// add hover/touch functionality to each feature layer
				onEachFeature: function (feature, layer) {
					// when mousing over a layer
					layer.on("mouseover", function () {
						// change the stroke color and bring that element to the front
						layer
							.setStyle({
								color: "#ffffd4",
								weight: 2,
							})
							.bringToFront();
					});

					// on mousing off layer
					layer.on("mouseout", function () {
						// reset the layer style to its original stroke color
						layer.setStyle({
							color: "rgba (0,0,0,0)",
						});
					});

					// on clicking layer
					layer.on("click", function (e) {
						map.setView(e.latlng, 15)
						console.log(e)
					});
				},
			}).addTo(map);

			console.log(addresses);
			updateTable(addresses, "2020"); // build table
			addUi(addresses); // add the UI controls
			updateMap(addresses); // draw the map

			const search = document.querySelector("#search-bar");
			const results = document.querySelector("#search-results select");
			search.addEventListener('input', function (e) {
				if (e.target.value.length > 3) {
					searchAddresses(e.target.value, addresses, results)
					results.className = "show"
				} else {
					results.className = "hide"
				}
			})
			results.addEventListener('input', function (e) {
				zoomTo(e.target.value, addresses);
			});
		}

		const modalButton = document.getElementById("modalButton");
		const modalWindow = document.getElementById("infoModal");
		let buttonclick = false;
		modalButton.addEventListener('click', function () {
			console.log(buttonclick);
			if (!buttonclick) {
				modalWindow.className = "show";
				modalButton.style.backgroundColor = "darkgray";
				modalButton.innerHTML = "Less about foreclosure sales";
			} else if (buttonclick == true) {
				modalWindow.className = "hide";
				modalButton.style.backgroundColor = "lightgray";
				modalButton.innerHTML = "More about foreclosure sales";
			}
			buttonclick = !buttonclick;
		});

		function makeRandom(coord) {
			const sign = Math.random() < 0.5 ? -1 : 1;
			return Number(coord) + (Math.random() * 0.0005 * sign);
		}

		function searchAddresses(v, addresses, results) {
			let returns = []
			addresses.eachLayer(function (l) {
				const address = l.feature.properties.PROPERTY;
				if (address.toLowerCase().includes(v.toLowerCase())) {
					returns.push([address, l._leaflet_id])
				}
			})
			returns.sort()
			returns = returns.map(function (r) {
				return `<option value="${r[1]}">${r[0]}</option>`
			})
			if (returns.length == 0) {
				returns.push(`<option>No results</option>`)
			}
			results.innerHTML = "<option>Select from below...</option>";
			results.innerHTML += `${returns.join('\n')}`;
		}

		function zoomTo(v, addresses) {
			addresses.eachLayer(function (l) {
				const address = l.feature.properties;
				if (l._leaflet_id == v) {
					map.setView(l.getLatLng(), 15)
					l.setStyle({
						color: "goldenrod",
						fillColor: "gold",
						weight: 2.5,
					})
					l.openPopup()
				}
			})
		}

		function updateMap(addresses) {
			console.log(addresses);

			// loop through each address layer to update the color and tooltip info
			addresses.eachLayer(function (layer) {
				const props = layer.feature.properties;
				const year = props["SALE_DATE"];

				// set the fill color of layer based on its value
				layer.setStyle({
					fillColor: getColor(year),
				});

				let tooltipInfo = '';
				if (props["PURCHASER"] == "WITHDRAWN") {
					tooltipInfo = `<b>${props["PROPERTY"]}</b><br><i>Sale Withdrawn</i>, ${props["SALE_DATE"]}.<br>A withdrawn foreclosure sale means that the lender canceled the judicial sale of the property. This can occur for a variety of reasons, including non-judicial sale, debt settlement, delay, or legal proceedings.`;
				} else if (layer.feature.properties.PROPERTY) {
					tooltipInfo = `<b>${props["PROPERTY"]}</b><br>Date of Sale: ${props["SALE_DATE"]}<br> Sale Price: $${props["PURCHASE"].toLocaleString('en-US', { style: 'currency', currency: 'USD' })}<br>Purchaser: <i>${props["PURCHASER"]}</i>`;
				} else {
					tooltipInfo = `<b>Incomplete Sale Data</b><br><i>For some foreclosed properties, the data available through the courts is incomplete.</i>`;
				};
				layer.bindPopup(tooltipInfo, {
					sticky: true,
				});
			});
		};

		function updateTable(addresses, year) {
			// Get the table body element
			const tableBody = document.querySelector('#top-purchasers-table tbody');
			// Clear the table body
			tableBody.innerHTML = '';
			// Get the current count of purchasers for the given year
			const purchaserCount = getPurchaserCount(addresses, year);
			// Sort the purchaser counts in descending order
			const sortedPurchasers = Object.entries(purchaserCount).sort((a, b) => b[1] - a[1]);

			// Take the top 5 purchasers
			const topPurchasers = sortedPurchasers.slice(0, 5);
			// Create a row for each purchaser
			const rows = topPurchasers.map(([name, count]) => {
				// Create a new table row element
				const row = document.createElement('tr');
				// Create a new table cell element for the name
				const nameCell = document.createElement('td');
				nameCell.textContent = name;
				// Create a new table cell element for the count
				const countCell = document.createElement('td');
				countCell.textContent = count;
				// Append the cells to the row
				row.appendChild(nameCell);
				row.appendChild(countCell);
				return row;
			});

			// Append the rows to the table body
			rows.forEach(row => tableBody.appendChild(row));
		}

		function getPurchaserCount(addresses, year) {
			const purchaserCounts = {};
			addresses.eachLayer(function (layer) {
				const p = layer.feature.properties;
				// Handle cases where the purchaser is null
				if (p.PURCHASER == null) {
					p.PURCHASER = "UNKNOWN"
				}
				if (p.SALE_DATE.includes(year) && !p.PURCHASER.includes("WITHDRAWN") && !p.PURCHASER.includes("COUNTY OF JEFFERSON")) {
					// Get the name of the purchaser
					const name = p.PURCHASER;
					// If the name is not yet in the dictionary, add it with a count of 0
					if (!purchaserCounts[name]) {
						purchaserCounts[name] = 0;
					}
					// Increment the count for the purchaser by 1
					purchaserCounts[name] += 1;
				}
			});
			// Return the dictionary of purchaser names and counts
			return purchaserCounts;
			console.log(purchaserCounts); // log the dictionary of purchaser names and counts
		}

		// Get color of county
		function getColor(year) {
			if (year.includes("2016") && (attributeValue == 2016)) {
				return "#a6cee3";
			} else if (year.includes("2017") && (attributeValue == 2017)) {
				return "#1f78b4";
			} else if (year.includes("2018") && (attributeValue == 2018)) {
				return "#b2df8a";
			} else if (year.includes("2019") && (attributeValue == 2019)) {
				return "#33a02c";
			} else if (year.includes("2020") && (attributeValue == 2020)) {
				return "#fb9a99";
			} else {
				return "rgba(255, 255, 255, 0.05)"
			}
		}

		function addUi(addresses) {
			const dropdown = document.querySelector('#dropdown-ui select')
			dropdown.addEventListener('change', function (e) {
				// get the value of the selected option
				attributeValue = e.target.value;
				this.style.backgroundColor = getColor(attributeValue);
				// update the map
				updateMap(addresses);
				updateTable(addresses, attributeValue); // attributeValue = year
			});
		}
	</script>
</body>

</html>